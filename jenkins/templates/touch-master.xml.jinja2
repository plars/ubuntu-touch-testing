{% extends "touch-base.xml.jinja2" %}
{% block triggers %}
  <triggers class="vector">
    <com.redfin.hudson.UrlChangeTrigger>
      <spec></spec>
      <url>{{trigger_url}}</url>
    </com.redfin.hudson.UrlChangeTrigger>
  </triggers>
{% endblock %}

{% block shellcmds %}
      <command>set -e
rm -rf *
{% include "touch-setup.xml.jinja2" %}

mv .device.$$ device-lock
      </command>
{% endblock %}

{% block extrasteps %}
{% for project in projects %}
    <hudson.plugins.parameterizedtrigger.TriggerBuilder>
      <configs>
        <hudson.plugins.parameterizedtrigger.BlockableBuildTriggerConfig>
	  <configs>
            <hudson.plugins.parameterizedtrigger.FileBuildParameters>
              <propertiesFile>device-lock</propertiesFile>
              <failTriggerOnMissing>true</failTriggerOnMissing>
            </hudson.plugins.parameterizedtrigger.FileBuildParameters>
          </configs>
          <projects>{{project}}</projects>
          <condition>ALWAYS</condition>
          <triggerWithNoParameters>false</triggerWithNoParameters>
          <block>
{% if "install-and-boot" in project %}
            <buildStepFailureThreshold>
              <name>FAILURE</name>
              <ordinal>2</ordinal>
              <color>RED</color>
            </buildStepFailureThreshold>
{% endif %}
            <unstableThreshold>
              <name>UNSTABLE</name>
              <ordinal>1</ordinal>
              <color>YELLOW</color>
            </unstableThreshold>
{% if "install-and-boot" in project or "default" in project %}
            <failureThreshold>
              <name>FAILURE</name>
              <ordinal>2</ordinal>
              <color>RED</color>
            </failureThreshold>
{% endif %}
          </block>
          <buildAllNodesWithLabel>false</buildAllNodesWithLabel>
        </hudson.plugins.parameterizedtrigger.BlockableBuildTriggerConfig>
      </configs>
    </hudson.plugins.parameterizedtrigger.TriggerBuilder>
{% endfor %}
{% endblock %}
{% block timeout %}
  <timeoutMinutes>300</timeoutMinutes>
{% endblock timeout %}
{% block artifactblock %}{% endblock %}
{% block descriptionsetter %}{% endblock %}
{% block buildpublisher %}{% endblock %}
{% block mailer %}{% endblock %}
{% block buildtrigger %}
    <hudson.plugins.parameterizedtrigger.BuildTrigger>
      <configs>
        <hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
          <configs>
            <hudson.plugins.parameterizedtrigger.FileBuildParameters>
              <propertiesFile>device-lock</propertiesFile>
              <failTriggerOnMissing>true</failTriggerOnMissing>
            </hudson.plugins.parameterizedtrigger.FileBuildParameters>
          </configs>
          <projects>smoke-master-free</projects>
          <condition>ALWAYS</condition>
          <triggerWithNoParameters>false</triggerWithNoParameters>
        </hudson.plugins.parameterizedtrigger.BuildTriggerConfig>
      </configs>
    </hudson.plugins.parameterizedtrigger.BuildTrigger>
{% endblock %}
